const ss = SpreadsheetApp.getActiveSpreadsheet();

function doPost(e) {
  try {
    const request = JSON.parse(e.postData.contents);
    
    if (!verifyApiKey(request.apiKey)) {
      return respond({ success: false, error: "Unauthorized" });
    }
    
    const { action, data = {} } = request;
    const actions = {
      'login': () => loginStaff(data),
      'getMenu': () => getMenu(),
      'addMenu': () => addMenu(data),
      'updateMenu': () => updateMenu(data),
      'deleteMenu': () => deleteMenu(data),
      'createOrder': () => createOrder(data),
      'saveOrder': () => saveOrder(data),
      'completeOrder': () => completeOrder(data),
      'getOrders': () => getOrders(data),
      'updateOrder': () => updateOrder(data),
      'cancelOrder': () => cancelOrder(data),
      'getDailySales': () => getDailySales(data),
      'getWeeklySales': () => getWeeklySales(data),
      'getMonthlySales': () => getMonthlySales(data),
      'getShopInfo': () => getShopInfo(),
      'getTodayOrderCount': () => getTodayOrderCount(),
      'getStaffList': () => getStaffList(),
      'addStaff': () => addStaff(data),
      'deleteStaff': () => deleteStaff(data),
      'saveSettings': () => saveSettings(data),
      'getSettings': () => getSettings(),
    };
    
    const handler = actions[action];
    return respond(handler ? handler() : { success: false, error: "Unknown action" });
    
  } catch(err) {
    return respond({ success: false, error: err.toString() });
  }
}

function doGet() {
  return respond({ success: true, message: "POSKedai API Running" });
}

function respond(data) {
  return ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}

function verifyApiKey(key) {
  const config = ss.getSheetByName("Config").getDataRange().getValues();
  return config.some(row => row[0] === "API_KEY" && row[1] === key);
}

function genId(prefix) {
  return prefix + Date.now() + Math.floor(Math.random() * 1000);
}

function myDate() {
  return Utilities.formatDate(new Date(), "Asia/Kuala_Lumpur", "yyyy-MM-dd");
}

function myTime() {
  return Utilities.formatDate(new Date(), "Asia/Kuala_Lumpur", "HH:mm:ss"); 
}

// ============================================
// LOGIN
// ============================================
function loginStaff(data) {
  const sheet = ss.getSheetByName("Staff");
  if (!sheet) return { success: true, staff: { name: "Admin", role: "admin" } };
  
  const rows = sheet.getDataRange().getValues();
  for (let i = 1; i < rows.length; i++) {
    if (String(rows[i][0]) === String(data.pin)) {
      return {
        success: true,
        staff: { name: rows[i][1], role: rows[i][2] || "staff" }
      };
    }
  }
  return { success: false, error: "PIN tidak sah!" };
}

// ============================================
// STAFF MANAGEMENT (NEW)
// ============================================
function getStaffList() {
  const sheet = ss.getSheetByName("Staff");
  if (!sheet) return { success: true, staffList: [] };
  
  const rows = sheet.getDataRange().getValues();
  const staffList = [];
  for (let i = 1; i < rows.length; i++) {
    staffList.push({
      pin: String(rows[i][0]),
      name: rows[i][1],
      role: rows[i][2] || "staff",
      row: i + 1
    });
  }
  return { success: true, staffList };
}

function addStaff(data) {
  if (!data.pin || !data.name) return { success: false, error: "PIN dan Nama diperlukan!" };
  
  const sheet = ss.getSheetByName("Staff");
  if (!sheet) return { success: false, error: "Sheet Staff tidak dijumpai!" };
  
  // Check duplicate PIN
  const rows = sheet.getDataRange().getValues();
  for (let i = 1; i < rows.length; i++) {
    if (String(rows[i][0]) === String(data.pin)) {
      return { success: false, error: "PIN sudah digunakan!" };
    }
  }
  
  sheet.appendRow([String(data.pin), data.name, data.role || "staff"]);
  return { success: true, message: "Staff '" + data.name + "' ditambah!" };
}

function deleteStaff(data) {
  if (!data.pin) return { success: false, error: "PIN diperlukan!" };
  
  const sheet = ss.getSheetByName("Staff");
  if (!sheet) return { success: false, error: "Sheet Staff tidak dijumpai!" };
  
  const rows = sheet.getDataRange().getValues();
  for (let i = 1; i < rows.length; i++) {
    if (String(rows[i][0]) === String(data.pin)) {
      sheet.deleteRow(i + 1);
      return { success: true, message: "Staff dipadam!" };
    }
  }
  return { success: false, error: "Staff tidak dijumpai!" };
}

// ============================================
// SETTINGS - QR & BANK (NEW)
// ============================================
function saveSettings(data) {
  const sheet = ss.getSheetByName("Config");
  if (!sheet) return { success: false, error: "Sheet Config tidak dijumpai!" };
  
  const rows = sheet.getDataRange().getValues();
  const keysToUpdate = {};
  
  if (data.qrImage !== undefined) keysToUpdate["QR_IMAGE"] = data.qrImage;
  if (data.bankName !== undefined) keysToUpdate["BANK_NAME"] = data.bankName;
  if (data.bankAccount !== undefined) keysToUpdate["BANK_ACCOUNT"] = data.bankAccount;
  if (data.bankHolder !== undefined) keysToUpdate["BANK_HOLDER"] = data.bankHolder;
  
  for (const [key, value] of Object.entries(keysToUpdate)) {
    let found = false;
    for (let i = 0; i < rows.length; i++) {
      if (rows[i][0] === key) {
        sheet.getRange(i + 1, 2).setValue(value);
        found = true;
        break;
      }
    }
    if (!found) {
      sheet.appendRow([key, value]);
    }
  }
  
  return { success: true, message: "Tetapan disimpan!" };
}

function getSettings() {
  const config = ss.getSheetByName("Config").getDataRange().getValues();
  const info = {};
  config.forEach(row => { info[row[0]] = row[1]; });
  return {
    success: true,
    qrImage: info.QR_IMAGE || "",
    bankName: info.BANK_NAME || "",
    bankAccount: info.BANK_ACCOUNT || "",
    bankHolder: info.BANK_HOLDER || ""
  };
}

// ============================================
// MENU
// ============================================
function getMenu() {
  const rows = ss.getSheetByName("Menu").getDataRange().getValues();
  const menu = [];
  for (let i = 1; i < rows.length; i++) {
    if (rows[i][4] === "active") {
      menu.push({
        id: rows[i][0], name: rows[i][1],
        price: parseFloat(rows[i][2]),
        category: rows[i][3] || "Lain-lain",
        status: rows[i][4]
      });
    }
  }
  return { success: true, menu };
}

function addMenu(data) {
  const id = genId("M");
  ss.getSheetByName("Menu").appendRow([
    id, data.name, parseFloat(data.price),
    data.category || "Lain-lain", "active"
  ]);
  return { success: true, message: "Menu '" + data.name + "' ditambah!", id };
}

function updateMenu(data) {
  const sheet = ss.getSheetByName("Menu");
  const rows = sheet.getDataRange().getValues();
  for (let i = 1; i < rows.length; i++) {
    if (rows[i][0] === data.id) {
      if (data.name) sheet.getRange(i+1, 2).setValue(data.name);
      if (data.price !== undefined) sheet.getRange(i+1, 3).setValue(parseFloat(data.price));
      if (data.category) sheet.getRange(i+1, 4).setValue(data.category);
      return { success: true, message: "Menu dikemaskini!" };
    }
  }
  return { success: false, error: "Menu tidak dijumpai!" };
}

function deleteMenu(data) {
  const sheet = ss.getSheetByName("Menu");
  const rows = sheet.getDataRange().getValues();
  for (let i = 1; i < rows.length; i++) {
    if (rows[i][0] === data.id) {
      sheet.getRange(i+1, 5).setValue("inactive");
      return { success: true, message: "Menu dipadam!" };
    }
  }
  return { success: false, error: "Menu tidak dijumpai!" };
}

// ============================================
// ORDERS - CREATE (immediate complete)
// ============================================
function createOrder(data) {
  const sheet = ss.getSheetByName("Orders");
  const id = genId("ORD");
  const today = myDate();
  const time = myTime();
  
  const rows = sheet.getDataRange().getValues();
  let count = 0;
  for (let i = 1; i < rows.length; i++) {
    try {
      const d = Utilities.formatDate(new Date(rows[i][1]), "Asia/Kuala_Lumpur", "yyyy-MM-dd");
      if (d === today) count++;
    } catch(e) {}
  }
  const orderNo = count + 1;
  
  let subtotal = 0;
  data.items.forEach(item => { subtotal += item.price * item.qty; });
  
  const discountAmt = data.discount || 0;
  const total = Math.max(0, subtotal - discountAmt);
  
  sheet.appendRow([
    id, today, time,
    JSON.stringify(data.items),
    subtotal.toFixed(2),
    discountAmt.toFixed(2),
    total.toFixed(2),
    "completed",
    data.tableNo || "-",
    data.paymentMethod || "cash",
    data.staffName || "-",
    orderNo
  ]);
  
  return {
    success: true,
    message: "Order #" + orderNo + " berjaya!",
    orderId: id, orderNo, total: total.toFixed(2)
  };
}

// ============================================
// ORDERS - SAVE (pending, bayar kemudian) (NEW)
// ============================================
function saveOrder(data) {
  const sheet = ss.getSheetByName("Orders");
  const id = genId("ORD");
  const today = myDate();
  const time = myTime();
  
  const rows = sheet.getDataRange().getValues();
  let count = 0;
  for (let i = 1; i < rows.length; i++) {
    try {
      const d = Utilities.formatDate(new Date(rows[i][1]), "Asia/Kuala_Lumpur", "yyyy-MM-dd");
      if (d === today) count++;
    } catch(e) {}
  }
  const orderNo = count + 1;
  
  let subtotal = 0;
  data.items.forEach(item => { subtotal += item.price * item.qty; });
  
  const discountAmt = data.discount || 0;
  const total = Math.max(0, subtotal - discountAmt);
  
  sheet.appendRow([
    id, today, time,
    JSON.stringify(data.items),
    subtotal.toFixed(2),
    discountAmt.toFixed(2),
    total.toFixed(2),
    "pending",
    data.tableNo || "-",
    "-",
    data.staffName || "-",
    orderNo
  ]);
  
  return {
    success: true,
    message: "Pesanan #" + orderNo + " disimpan!",
    orderId: id, orderNo, total: total.toFixed(2)
  };
}

// ============================================
// ORDERS - COMPLETE PENDING (NEW)
// ============================================
function completeOrder(data) {
  const sheet = ss.getSheetByName("Orders");
  const rows = sheet.getDataRange().getValues();
  
  for (let i = 1; i < rows.length; i++) {
    if (rows[i][0] === data.orderId) {
      if (rows[i][7] !== "pending") {
        return { success: false, error: "Pesanan ini bukan pending!" };
      }
      
      sheet.getRange(i+1, 8).setValue("completed");
      sheet.getRange(i+1, 10).setValue(data.paymentMethod || "cash");
      
      const order = {
        orderId: rows[i][0],
        date: Utilities.formatDate(new Date(rows[i][1]), "Asia/Kuala_Lumpur", "yyyy-MM-dd"),
        time: rows[i][2],
        items: JSON.parse(rows[i][3]),
        subtotal: parseFloat(rows[i][4]),
        discount: parseFloat(rows[i][5]) || 0,
        total: parseFloat(rows[i][6]),
        tableNo: rows[i][8] || "-",
        paymentMethod: data.paymentMethod || "cash",
        staffName: rows[i][10] || "-",
        orderNo: rows[i][11] || 0
      };
      
      return {
        success: true,
        message: "Pesanan #" + order.orderNo + " selesai!",
        order: order
      };
    }
  }
  return { success: false, error: "Pesanan tidak dijumpai!" };
}

// ============================================
// ORDERS - GET, UPDATE, CANCEL
// ============================================
function getOrders(data) {
  const sheet = ss.getSheetByName("Orders");
  const rows = sheet.getDataRange().getValues();
  const target = data.date || myDate();
  const orders = [];
  
  for (let i = 1; i < rows.length; i++) {
    let d;
    try { d = Utilities.formatDate(new Date(rows[i][1]), "Asia/Kuala_Lumpur", "yyyy-MM-dd"); }
    catch(e) { d = rows[i][1]; }
    
    if (d === target) {
      orders.push({
        orderId: rows[i][0], date: d, time: rows[i][2],
        items: JSON.parse(rows[i][3]),
        subtotal: parseFloat(rows[i][4]),
        discount: parseFloat(rows[i][5]) || 0,
        total: parseFloat(rows[i][6]),
        status: rows[i][7],
        tableNo: rows[i][8] || "-",
        paymentMethod: rows[i][9] || "cash",
        staffName: rows[i][10] || "-",
        orderNo: rows[i][11] || 0
      });
    }
  }
  orders.reverse();
  return { success: true, orders, date: target };
}

function updateOrder(data) {
  const sheet = ss.getSheetByName("Orders");
  const rows = sheet.getDataRange().getValues();
  
  for (let i = 1; i < rows.length; i++) {
    if (rows[i][0] === data.orderId) {
      let subtotal = 0;
      data.items.forEach(item => { subtotal += item.price * item.qty; });
      const discount = data.discount || parseFloat(rows[i][5]) || 0;
      const total = Math.max(0, subtotal - discount);
      
      sheet.getRange(i+1, 4).setValue(JSON.stringify(data.items));
      sheet.getRange(i+1, 5).setValue(subtotal.toFixed(2));
      sheet.getRange(i+1, 6).setValue(discount.toFixed(2));
      sheet.getRange(i+1, 7).setValue(total.toFixed(2));
      if (data.tableNo) sheet.getRange(i+1, 9).setValue(data.tableNo);
      if (data.paymentMethod) sheet.getRange(i+1, 10).setValue(data.paymentMethod);
      
      return { success: true, message: "Order dikemaskini!", total: total.toFixed(2) };
    }
  }
  return { success: false, error: "Order tidak dijumpai!" };
}

function cancelOrder(data) {
  const sheet = ss.getSheetByName("Orders");
  const rows = sheet.getDataRange().getValues();
  for (let i = 1; i < rows.length; i++) {
    if (rows[i][0] === data.orderId) {
      sheet.getRange(i+1, 8).setValue("cancelled");
      return { success: true, message: "Order dibatalkan!" };
    }
  }
  return { success: false, error: "Order tidak dijumpai!" };
}

function getTodayOrderCount() {
  const sheet = ss.getSheetByName("Orders");
  const rows = sheet.getDataRange().getValues();
  const today = myDate();
  let count = 0;
  for (let i = 1; i < rows.length; i++) {
    try {
      const d = Utilities.formatDate(new Date(rows[i][1]), "Asia/Kuala_Lumpur", "yyyy-MM-dd");
      if (d === today) count++;
    } catch(e) {}
  }
  return { success: true, count };
}

// ============================================
// SALES REPORTS
// ============================================
function getDailySales(data) {
  const sheet = ss.getSheetByName("Orders");
  const rows = sheet.getDataRange().getValues();
  const target = data.date || myDate();
  
  let totalSales = 0, totalOrders = 0, cancelled = 0, totalDiscount = 0;
  let items = {}, payments = { cash: 0, qr: 0, transfer: 0 }, hourly = {};
  
  for (let i = 1; i < rows.length; i++) {
    let d;
    try { d = Utilities.formatDate(new Date(rows[i][1]), "Asia/Kuala_Lumpur", "yyyy-MM-dd"); }
    catch(e) { d = rows[i][1]; }
    
    if (d === target) {
      if (rows[i][7] === "completed") {
        const tot = parseFloat(rows[i][6]);
        totalSales += tot;
        totalOrders++;
        totalDiscount += parseFloat(rows[i][5]) || 0;
        
        const pm = rows[i][9] || "cash";
        if (payments[pm] !== undefined) payments[pm] += tot;
        
        const hr = String(rows[i][2]).substring(0, 2) + ":00";
        hourly[hr] = (hourly[hr] || 0) + tot;
        
        try {
          JSON.parse(rows[i][3]).forEach(item => {
            if (items[item.name]) {
              items[item.name].qty += item.qty;
              items[item.name].revenue += item.price * item.qty;
            } else {
              items[item.name] = { qty: item.qty, revenue: item.price * item.qty };
            }
          });
        } catch(e) {}
      } else if (rows[i][7] === "cancelled") { cancelled++; }
    }
  }
  
  const topItems = Object.entries(items)
    .map(([name, d]) => ({ name, qty: d.qty, revenue: d.revenue }))
    .sort((a, b) => b.qty - a.qty);
  
  return {
    success: true, date: target,
    totalSales: totalSales.toFixed(2),
    totalOrders, cancelledOrders: cancelled,
    totalDiscount: totalDiscount.toFixed(2),
    averageOrder: totalOrders > 0 ? (totalSales / totalOrders).toFixed(2) : "0.00",
    topItems, paymentBreakdown: payments, hourlySales: hourly
  };
}

function getWeeklySales(data) {
  const sheet = ss.getSheetByName("Orders");
  const rows = sheet.getDataRange().getValues();
  
  const days = [];
  for (let d = 6; d >= 0; d--) {
    const date = new Date();
    date.setDate(date.getDate() - d);
    days.push(Utilities.formatDate(date, "Asia/Kuala_Lumpur", "yyyy-MM-dd"));
  }
  
  const dailyData = {};
  days.forEach(d => { dailyData[d] = { sales: 0, orders: 0 }; });
  
  let totalWeek = 0, totalOrders = 0;
  
  for (let i = 1; i < rows.length; i++) {
    if (rows[i][7] !== "completed") continue;
    let d;
    try { d = Utilities.formatDate(new Date(rows[i][1]), "Asia/Kuala_Lumpur", "yyyy-MM-dd"); }
    catch(e) { continue; }
    
    if (dailyData[d] !== undefined) {
      const tot = parseFloat(rows[i][6]);
      dailyData[d].sales += tot;
      dailyData[d].orders++;
      totalWeek += tot;
      totalOrders++;
    }
  }
  
  return {
    success: true,
    weeklyTotal: totalWeek.toFixed(2),
    totalOrders,
    dailyData,
    days
  };
}

function getMonthlySales(data) {
  const sheet = ss.getSheetByName("Orders");
  const rows = sheet.getDataRange().getValues();
  const targetMonth = data.month || Utilities.formatDate(new Date(), "Asia/Kuala_Lumpur", "yyyy-MM");
  
  let totalMonth = 0, totalOrders = 0, totalDiscount = 0;
  let items = {};
  
  for (let i = 1; i < rows.length; i++) {
    if (rows[i][7] !== "completed") continue;
    let d;
    try { d = Utilities.formatDate(new Date(rows[i][1]), "Asia/Kuala_Lumpur", "yyyy-MM"); }
    catch(e) { continue; }
    
    if (d === targetMonth) {
      totalMonth += parseFloat(rows[i][6]);
      totalOrders++;
      totalDiscount += parseFloat(rows[i][5]) || 0;
      
      try {
        JSON.parse(rows[i][3]).forEach(item => {
          if (items[item.name]) {
            items[item.name].qty += item.qty;
            items[item.name].revenue += item.price * item.qty;
          } else {
            items[item.name] = { qty: item.qty, revenue: item.price * item.qty };
          }
        });
      } catch(e) {}
    }
  }
  
  const topItems = Object.entries(items)
    .map(([name, d]) => ({ name, qty: d.qty, revenue: d.revenue }))
    .sort((a, b) => b.revenue - a.revenue);
  
  return {
    success: true, month: targetMonth,
    totalSales: totalMonth.toFixed(2),
    totalOrders, totalDiscount: totalDiscount.toFixed(2),
    averageOrder: totalOrders > 0 ? (totalMonth / totalOrders).toFixed(2) : "0.00",
    topItems
  };
}

// ============================================
// SHOP INFO
// ============================================
function getShopInfo() {
  const config = ss.getSheetByName("Config").getDataRange().getValues();
  const info = {};
  config.forEach(row => { info[row[0]] = row[1]; });
  return {
    success: true,
    shopName: info.SHOP_NAME || "Kedai Makan",
    shopAddress: info.SHOP_ADDRESS || "",
    shopPhone: info.SHOP_PHONE || "",
    brandColor: info.BRAND_COLOR || "#f97316",
    pakej: info.PAKEJ || "premium",
    qrImage: info.QR_IMAGE || "",
    bankName: info.BANK_NAME || "",
    bankAccount: info.BANK_ACCOUNT || "",
    bankHolder: info.BANK_HOLDER || ""
  };
}
